<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®¢æˆ·æ•°æ®é¢æ¿</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">

    <style>
        :root {
            --main-color: #1e3d59; /* é»˜è®¤æ·±è“ */
            --btn-color: #6f42c1;  /* é»˜è®¤ç´«è‰² */
            --btn-hover: #5a32a3;
        }

        body { background-color: #f8f9fa; }
        h2 { color: var(--main-color); }

        table.dataTable thead th {
            background-color: var(--main-color);
            color: white;
            text-align: center;
        }

        .btn-theme {
            background-color: var(--btn-color);
            color: white;
            border: none;
        }
        .btn-theme:hover {
            background-color: var(--btn-hover);
        }

        th, td {
            resize: both;
            overflow: auto;
            min-width: 80px;
            min-height: 30px;
        }

        mark { background-color: yellow; font-weight: bold; }
    </style>
</head>
<body class="container-fluid p-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>ğŸ“Š å®¢æˆ·æ•°æ®é¢æ¿</h2>
        <div>
            <label for="themeSelect" class="me-2">åˆ‡æ¢ä¸»é¢˜ï¼š</label>
            <select id="themeSelect" class="form-select d-inline-block w-auto">
                <option value="blue">æ·±è“</option>
                <option value="gray">æ·±ç°</option>
                <option value="purple">ç´«è‰²</option>
            </select>
        </div>
    </div>

    <!-- åˆ—é€‰æ‹©å™¨ -->
    <div id="columnToggles" class="mb-3"></div>

    <!-- æœç´¢æ¡† -->
    <input type="text" id="searchInput" class="form-control mb-3" placeholder="è¾“å…¥å…³é”®è¯æœç´¢...">

    <div class="table-responsive">
        <table id="dataTable" class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    {% for header in headers %}
                        <th data-col="{{ loop.index0 }}">{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in tables %}
                <tr>
                    {% for cell in row.values() %}
                        <td>{{ cell }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <script>
        // åˆå§‹åŒ– DataTable
        let table = new DataTable('#dataTable', {
            dom: 'Bfrtip',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-CN.json" }
        });

        // æœç´¢ + é«˜äº®
        document.getElementById("searchInput").addEventListener("keyup", function() {
            let input = this.value.toLowerCase();
            $("#dataTable tbody tr").each(function() {
                let rowText = $(this).text().toLowerCase();
                if (rowText.includes(input)) {
                    $(this).show();
                    $(this).find("td").each(function() {
                        let cellText = $(this).text();
                        if (input && cellText.toLowerCase().includes(input)) {
                            $(this).html(cellText.replace(new RegExp(input, "gi"), match => `<mark>${match}</mark>`));
                        } else {
                            $(this).html(cellText);
                        }
                    });
                } else {
                    $(this).hide();
                }
            });
        });

        // ä¸»é¢˜åˆ‡æ¢ + è®°å¿†
        function applyTheme(theme) {
            if (theme === "blue") {
                document.documentElement.style.setProperty("--main-color", "#1e3d59");
                document.documentElement.style.setProperty("--btn-color", "#1e3d59");
                document.documentElement.style.setProperty("--btn-hover", "#162c42");
            } else if (theme === "gray") {
                document.documentElement.style.setProperty("--main-color", "#343a40");
                document.documentElement.style.setProperty("--btn-color", "#343a40");
                document.documentElement.style.setProperty("--btn-hover", "#1d2124");
            } else if (theme === "purple") {
                document.documentElement.style.setProperty("--main-color", "#6f42c1");
                document.documentElement.style.setProperty("--btn-color", "#6f42c1");
                document.documentElement.style.setProperty("--btn-hover", "#5a32a3");
            }
            localStorage.setItem("theme", theme);
            document.getElementById("themeSelect").value = theme;
        }

        document.getElementById("themeSelect").addEventListener("change", function() {
            applyTheme(this.value);
        });

        // ä¿å­˜åˆ—å®½ & è¡Œé«˜
        function saveTableSizes() {
            let sizes = { cols: {}, rows: {} };
            document.querySelectorAll("#dataTable thead th").forEach((th, i) => {
                sizes.cols[i] = th.offsetWidth;
            });
            document.querySelectorAll("#dataTable tbody tr").forEach((tr, r) => {
                sizes.rows[r] = tr.offsetHeight;
            });
            localStorage.setItem("tableSizes", JSON.stringify(sizes));
        }

        function applyTableSizes() {
            let saved = localStorage.getItem("tableSizes");
            if (saved) {
                let sizes = JSON.parse(saved);
                document.querySelectorAll("#dataTable thead th").forEach((th, i) => {
                    if (sizes.cols[i]) th.style.width = sizes.cols[i] + "px";
                });
                document.querySelectorAll("#dataTable tbody tr").forEach((tr, r) => {
                    if (sizes.rows[r]) tr.style.height = sizes.rows[r] + "px";
                });
            }
        }

        document.addEventListener("mouseup", saveTableSizes);

        // åˆ—å¯è§æ€§æ§åˆ¶
        function buildColumnToggles() {
            let headers = document.querySelectorAll("#dataTable thead th");
            let savedCols = JSON.parse(localStorage.getItem("visibleCols") || "null");
            if (!savedCols) {
                savedCols = Array.from(headers).map((_, i) => true); // é»˜è®¤å…¨æ˜¾ç¤º
            }

            headers.forEach((th, index) => {
                let colName = th.innerText;
                let checked = savedCols[index] ? "checked" : "";
                $("#columnToggles").append(`
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="col_${index}" ${checked}>
                        <label class="form-check-label" for="col_${index}">${colName}</label>
                    </div>
                `);

                // åˆå§‹åº”ç”¨éšè—çŠ¶æ€
                if (!savedCols[index]) {
                    table.column(index).visible(false);
                }

                // ç»‘å®šäº‹ä»¶
                $(`#col_${index}`).on("change", function() {
                    table.column(index).visible(this.checked);
                    savedCols[index] = this.checked;
                    localStorage.setItem("visibleCols", JSON.stringify(savedCols));
                });
            });
        }

        // é¡µé¢åŠ è½½æ—¶åº”ç”¨ä¸»é¢˜ & è¡¨æ ¼å°ºå¯¸ & åˆ—å¯è§æ€§
        window.onload = function() {
            let savedTheme = localStorage.getItem("theme") || "blue";
            applyTheme(savedTheme);
            applyTableSizes();
            buildColumnToggles();
        };
    </script>
</body>
</html>

