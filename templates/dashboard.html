<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ÂÆ¢Êà∑Êï∞ÊçÆÈù¢Êùø</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <!-- Êó•ÊúüÈÄâÊã©Âô® Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        :root {
            --main-color: #1e3d59;
            --btn-color: #6f42c1;
            --btn-hover: #5a32a3;
        }

        body { background-color: #f8f9fa; }
        h2 { color: var(--main-color); }

        table.dataTable thead th {
            background-color: var(--main-color);
            color: white;
            text-align: center;
        }

        .btn-theme {
            background-color: var(--btn-color);
            color: white;
            border: none;
        }
        .btn-theme:hover {
            background-color: var(--btn-hover);
        }

        th, td {
            resize: both;
            overflow: auto;
            min-width: 80px;
            min-height: 30px;
        }

        mark { background-color: yellow; font-weight: bold; }
    </style>
</head>
<body class="container-fluid p-4">

    <h2 class="mb-4">üìä ÂÆ¢Êà∑Êï∞ÊçÆÈù¢Êùø</h2>

    <!-- Â∑•ÂÖ∑Ê†èÂç°Áâá -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <!-- ÊêúÁ¥¢Ê°Ü -->
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="üîç ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢...">
                </div>

                <!-- Êó•ÊúüÈÄâÊã© -->
                <div class="col-md-4">
                    <input type="text" id="dateRange" class="form-control" placeholder="üìÖ ÈÄâÊã©Êó•ÊúüËåÉÂõ¥">
                </div>

                <!-- ‰∏ªÈ¢òÂàáÊç¢ -->
                <div class="col-md-2">
                    <select id="themeSelect" class="form-select">
                        <option value="blue">Ê∑±Ëìù</option>
                        <option value="gray">Ê∑±ÁÅ∞</option>
                        <option value="purple">Á¥´Ëâ≤</option>
                    </select>
                </div>
            </div>

            <!-- ÂàóÈÄâÊã© -->
            <div class="mt-3" id="columnToggles"></div>
        </div>
    </div>

    <!-- Ë°®Ê†º -->
    <div class="table-responsive">
        <table id="dataTable" class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    {% for header in headers %}
                        <th data-col="{{ loop.index0 }}">{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in tables %}
                <tr>
                    {% for cell in row.values() %}
                        <td>{{ cell }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <!-- Flatpickr Êó•ÊúüÈÄâÊã© -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>

    <script>
        // ÂàùÂßãÂåñ DataTable
        let table = new DataTable('#dataTable', {
            dom: 'Bfrtip',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh-CN.json" }
        });

        // ÊêúÁ¥¢ + È´ò‰∫Æ
        document.getElementById("searchInput").addEventListener("keyup", function() {
            let input = this.value.toLowerCase();
            $("#dataTable tbody tr").each(function() {
                let rowText = $(this).text().toLowerCase();
                if (rowText.includes(input)) {
                    $(this).show();
                    $(this).find("td").each(function() {
                        let cellText = $(this).text();
                        if (input && cellText.toLowerCase().includes(input)) {
                            $(this).html(cellText.replace(new RegExp(input, "gi"), match => `<mark>${match}</mark>`));
                        } else {
                            $(this).html(cellText);
                        }
                    });
                } else {
                    $(this).hide();
                }
            });
        });

        // Êó•ÊúüÈÄâÊã©Âô®
        flatpickr("#dateRange", {
            mode: "range",
            locale: "zh",
            dateFormat: "Y-m-d",
            onChange: function(selectedDates) {
                if (selectedDates.length === 2) {
                    let start = selectedDates[0];
                    let end = selectedDates[1];
                    $("#dataTable tbody tr").each(function() {
                        let dateText = $(this).find("td:contains('2025')").text(); // ÂÅáËÆæÊó•ÊúüÂàóÂê´ÊúâÂπ¥‰ªΩ
                        if (dateText) {
                            let cellDate = new Date(dateText);
                            if (cellDate >= start && cellDate <= end) {
                                $(this).show();
                            } else {
                                $(this).hide();
                            }
                        }
                    });
                }
            }
        });

        // ‰∏ªÈ¢òÂàáÊç¢ + ËÆ∞ÂøÜ
        function applyTheme(theme) {
            if (theme === "blue") {
                document.documentElement.style.setProperty("--main-color", "#1e3d59");
                document.documentElement.style.setProperty("--btn-color", "#1e3d59");
                document.documentElement.style.setProperty("--btn-hover", "#162c42");
            } else if (theme === "gray") {
                document.documentElement.style.setProperty("--main-color", "#343a40");
                document.documentElement.style.setProperty("--btn-color", "#343a40");
                document.documentElement.style.setProperty("--btn-hover", "#1d2124");
            } else if (theme === "purple") {
                document.documentElement.style.setProperty("--main-color", "#6f42c1");
                document.documentElement.style.setProperty("--btn-color", "#6f42c1");
                document.documentElement.style.setProperty("--btn-hover", "#5a32a3");
            }
            localStorage.setItem("theme", theme);
            document.getElementById("themeSelect").value = theme;
        }

        document.getElementById("themeSelect").addEventListener("change", function() {
            applyTheme(this.value);
        });

        // ÂàóÈÄâÊã©Âô®
        function buildColumnToggles() {
            let headers = document.querySelectorAll("#dataTable thead th");
            let savedCols = JSON.parse(localStorage.getItem("visibleCols") || "null");
            if (!savedCols) savedCols = Array.from(headers).map(() => true);

            headers.forEach((th, index) => {
                let colName = th.innerText;
                let checked = savedCols[index] ? "checked" : "";
                $("#columnToggles").append(`
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="col_${index}" ${checked}>
                        <label class="form-check-label" for="col_${index}">${colName}</label>
                    </div>
                `);
                if (!savedCols[index]) table.column(index).visible(false);

                $(`#col_${index}`).on("change", function() {
                    table.column(index).visible(this.checked);
                    savedCols[index] = this.checked;
                    localStorage.setItem("visibleCols", JSON.stringify(savedCols));
                });
            });
        }

        // È°µÈù¢ÂàùÂßãÂåñ
        window.onload = function() {
            let savedTheme = localStorage.getItem("theme") || "blue";
            applyTheme(savedTheme);
            buildColumnToggles();
        };
    </script>
</body>
</html>
